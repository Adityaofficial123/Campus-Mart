<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CampusMart</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">

</head>

<body>
  
  <header id="navbar-container">
    <nav class="market-navbar">

  <div class="market-navbar__container">
    <div class="market-navbar__logo" onclick="window.location.href='index.html'">
      <img src="EKD logo.jpeg" alt="CampusMart Logo" class="market-navbar__logo-img" />
      <span class="market-navbar__brand">CampusMart</span>
    </div>
    <div class="market-navbar__searchbar">
      <select class="market-navbar__select" id="categoryFilter" aria-label="Category">
        <option value="All">All</option>
        <option value="Electronics">Electronics</option>
        <option value="Books">Books</option>
        <option value="Calculators">Calculators</option>
        <option value="Stationery">Stationery</option>
        <option value="Laptops">Laptops</option>
        <option value="Smartphones">Smartphones</option>
        <option value="Gaming">Gaming</option>
        <option value="Beauty">Beauty</option>
        <option value="Pets">Pets</option>
        <option value="Clothing">Clothing</option>
        <option value="Accessories">Accessories</option>
        <option value="Home Essentials">Home Essentials</option>
        <option value="Art & Craft">Art & Craft</option>
        <option value="Furniture">Furniture</option>
        <option value="Sports">Sports</option>
        <option value="Music">Music</option>
        <option value="Kitchen">Kitchen</option>
        <option value="Toys">Toys</option>
        <option value="Other">Other</option>
      </select>
      <div class="market-navbar__search-wrapper">
        <input type="text" class="market-navbar__search" id="searchInput" placeholder="Search products..." aria-label="Search products">
        <!-- <button class="market-navbar__search-btn" id="navbarSearchBtn" aria-label="Search"><i class="fa fa-search"></i></button> -->
      </div>
    </div>
    <ul class="market-navbar__links" id="marketNavbarLinks">
      <li><a href="index.html">Home</a></li>
      <li><a href="#shopSection">Shop</a></li>
      <li><a href="#sell">Sell</a></li>
      <!-- <li><a href="#" id="profileNav">Profile</a></li> -->
    </ul>
    <div class="market-navbar__actions">
      <button id="adminLoginBtn" class="market-navbar__btn market-navbar__btn--admin" title="Admin" aria-label="Admin"><i class="fa fa-user-shield"></i></button>
      <div class="market-navbar__cart" onclick="window.location.href='cart.html'" title="Cart" aria-label="Cart">
     
        <i class="fa-solid fa-cart-shopping"></i>
        <!-- <span id="cart-count" class="market-navbar__cart-badge"></span> -->
      </div>
      <span id="userEmail" style="display:none; color: #ebece7;" ></span>
      <button id="navbarLoginBtn" class="market-navbar__btn">Login</button>
      <button id="logoutBtn" class="market-navbar__btn" style="display:none;">Logout</button>
      <div id="recaptcha-container"></div>
    </div>
    <button class="market-navbar__hamburger" id="marketNavbarHamburger" aria-label="Toggle navigation">
      <span></span><span></span><span></span>
    </button>
  </div>
</nav>



  </header>
  <!-- Mobile Tray HTML -->
<div id="mobileTray" class="mobile-tray">
  <button class="tray-close-btn" id="closeTrayBtn">&times;</button>
  <div class="tray-section" id="trayUserId">Your ID: <span id="trayUserEmail">Not logged in</span></div>
  <button class="tray-btn" id="trayCartBtn"><i class="fa fa-shopping-cart"></i> Cart</button>
  <button class="tray-btn" id="trayAdminBtn"><i class="fa fa-user-shield"></i> Admin</button>
  <button class="tray-btn" id="trayLoginBtn"><i class="fa fa-sign-in-alt"></i> Login</button>
  <button class="tray-btn" id="trayLogoutBtn" style="display:none;"><i class="fa fa-sign-out-alt"></i> Logout</button>
</div>
  
  
  

  <!-- Hero Section (Modern, Responsive, Only Once) -->
  <section class="hero-section">
    <div class="hero-content">
      <h1 class="hero-title">Welcome to CampusMart</h1>
      <p class="hero-subtitle">Your trusted campus marketplace for buying and selling essentials, gadgets, books, and more.
      </p>
      <div class="hero-actions">
        <a href="#shopSection" class="hero-btn">Shop Now</a>
        <a href="#sell" class="hero-btn hero-btn-outline">Sell Your Product</a>
      </div>
    </div>
    <svg class="hero-wave" viewBox="0 0 1440 320">
      <path fill="#f8fafc" fill-opacity="1"
        d="M0,224L48,202.7C96,181,192,139,288,144C384,149,480,203,576,197.3C672,192,768,128,864,117.3C960,107,1056,149,1152,176C1248,203,1344,213,1392,218.7L1440,224L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z">
      </path>
    </svg>
  </section>

  <!-- Back to Top Button -->
  <!-- <button id="backToTopBtn" title="Go to top">‚Üë</button> -->

  <div class="main-content">
    <!-- Product Cards Section -->
    <section class="product-section">
      <h1 class="available-items-heading">Available Items</h1>

      <!-- Filter & Sort Section -->
      <div class="filter-sort-bar">
        <div class="filter-group">
          <button id="filterBtn" class="filter-btn">Filter <i class="fa fa-filter"></i></button>
          <div id="filterDropdown" class="filter-dropdown">
            <label><input type="checkbox" class="filter-category" value="Electronics"> Electronics</label>
            <label><input type="checkbox" class="filter-category" value="Books"> Books</label>
            <label><input type="checkbox" class="filter-category" value="Stationery"> Stationery</label>
            <label><input type="checkbox" class="filter-category" value="Laptops"> Laptops</label>
            <label><input type="checkbox" class="filter-category" value="Smartphones"> Smartphones</label>
            <label><input type="checkbox" class="filter-category" value="Clothing"> Clothing</label>
            <label><input type="checkbox" class="filter-category" value="Accessories"> Accessories</label>
            <label><input type="checkbox" class="filter-category" value="Other"> Other</label>
            <hr>
            <label>Price Range:</label>
            <input type="number" id="minPrice" placeholder="Min ‚Çπ" style="width:70px;"> -
            <input type="number" id="maxPrice" placeholder="Max ‚Çπ" style="width:70px;">
            <button id="applyFilterBtn" class="apply-btn">Apply</button>
          </div>
        </div>
        <div class="sort-group">
          <label for="sortSelect">Sort by:</label>
          <select id="sortSelect" class="sort-select">
            <option value="recent">Most Recently Added</option>
            <option value="low">Price: Low to High</option>
            <option value="high">Price: High to Low</option>
            <option value="az">Name: A-Z</option>
            <option value="za">Name: Z-A</option>
          </select>
        </div>
      </div>

      <!-- Product Cards Section (shop-section) -->
      <section class="shop-section" id="shopSection">
        <!-- Product cards will be rendered here by JS -->
      </section>
    </section>

     <div id="product-loading-spinner" style="display:none;text-align:center;margin:30px 0;">
        <i class="fa fa-spinner fa-spin" style="font-size:2.5rem;color:#ffb74d;"></i>
        <div style="margin-top:10px;color:#888;font-size:1.1rem;">Loading products...</div>
      </div>

    <!-- SELL PRODUCT (separate section) -->
    <section id="sell" class="sell-section">
      <div class="sell-container">
        <h2 class="sell-heading">Sell Your Product</h2>
        <p class="sell-subtitle">Fill the details below and reach thousands of customers!</p>

        <form id="sellForm" class="sell-form">
          <div class="form-group">
            <input type="text" id="productName" placeholder="Product Name" required>
          </div>

          <div class="form-group">
            <select id="productCategory" required>
              <option value="">Select a category</option>
              <option value="Electronics">Electronics</option>
              <option value="Books">Books</option>
              <option value="Calculators">Calculators</option>
              <option value="Stationery">Stationery</option>
              <option value="Laptops">Laptops</option>
              <option value="Smartphones">Smartphones</option>
              <option value="Gaming">Gaming</option>
              <option value="Beauty">Beauty</option>
              <option value="Clothing">Clothing</option>
              <option value="Accessories">Accessories</option>
              <option value="Art & Craft">Art & Craft</option>
              <option value="Sports">Sports</option>
              <option value="Music">Music</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <div class="form-group">
            <input type="number" id="productPrice" placeholder="Price (in ‚Çπ)" required>
          </div>

          <div class="form-group">
            <textarea id="productDescription" placeholder="Description" rows="4" required></textarea>
          </div>

          <div class="form-group">
            <input type="file" id="imageFile" accept="image/*" required>
          </div>

          <!-- Seller Details -->
          <div class="form-group">
            <input type="text" id="sellerName" placeholder="Your Name" required>
          </div>

          <div class="form-group">
            <input type="tel" id="sellerMobile" placeholder="Your Mobile Number" required>
          </div>

          <!-- Loader -->
          <div id="loading-spinner" style="display: none;">
            <p>Submitting...</p>
          </div>

          <button type="submit" class="sell-btn">Submit Product</button>
        </form>
      </div>
    </section>
<!-- instruction -->

<div class="seller-instructions-box">
  <h3>üë§ Seller Guidelines</h3>
  <ul>
    <li><span class="icon">‚úÖ</span> Login & fill out the product form.</li>
    <li><span class="icon">üí∞</span> Pay listing fee (first month free!).</li>
    <li><span class="icon">üìß</span> Check your email for listing confirmation.</li>
    <li><span class="icon">ü§ù</span> Meet buyer & show the product.</li>
    <li><span class="icon">‚ùå</span> <strong>Do not take payment directly from the buyer.</strong></li>
    <li><span class="icon">üîí</span> Buyer‚Äôs money is safe & sent to you after their confirmation.</li>
  </ul>
</div>

    <div id="sellerPaymentStatus" style="display:none; margin-top:20px; font-weight:bold;"></div>
  </div>

  <!-- Modern Responsive Footer -->
  <footer class="footer-modern">
    <div class="footer-container">
      <div class="footer-brand">
        <img src="EKD logo.jpeg" alt="CampusMart Logo" />
        <h2>CampusMart</h2>
        <p style="color:#bbb;max-width:220px;font-size:1rem;line-height:1.5;">Your trusted campus marketplace for
          buying and selling essentials, gadgets, books, and more.</p>
      </div>
      <div class="footer-links">
        <!-- Footer-related Sections (hidden by default) -->
<section id="faqSection" class="footer-info-section" style="display: none;">
  <h2>Frequently Asked Questions</h2>

  <div style="margin-top: 20px;">
    <h3 style="color:#555;">‚ùì How do I buy a product?</h3>
    <p>Browse the listings, click on the product you want, and click ‚ÄúProceed to Payment‚Äù to secure your purchase.</p>
  </div>

  <div style="margin-top: 20px;">
    <h3 style="color:#555;">‚ùì How do I confirm I‚Äôve received my product?</h3>
    <p>After receiving your product, go to your cart (top right) and click the ‚ÄúConfirm‚Äù button for that product.</p>
  </div>

  <div style="margin-top: 20px;">
    <h3 style="color:#555;">‚ùì What if I don‚Äôt like the product?</h3>
    <p>If you don‚Äôt like the product, we offer a full refund minus a 5% platform fee. Contact our support team to start a return.</p>
  </div>

  <div style="margin-top: 20px;">
    <h3 style="color:#555;">‚ùì How long does delivery take?</h3>
    <p>Typically, products are delivered within 3-5 business days. We‚Äôll update you via email with tracking details once shipped.</p>
  </div>

  <div style="margin-top: 20px;">
    <h3 style="color:#555;">‚ùì Can I cancel my order?</h3>
    <p>Yes, you can cancel within 2 hours of purchase by contacting our support team.</p>
  </div>
</section>


<section id="returnsSection" class="footer-info-section" style="display: none;">
  <h2>Returns</h2>
  <p>Return your product within 7 days of delivery for a full refund (minus 5% platform fee).</p>
</section>

<section id="shippingSection" class="footer-info-section" style="display: none;">
  <h2>Shipping</h2>
  <p>Shipping takes 3‚Äì5 business days. We‚Äôll update you via email!</p>
</section>

<section id="contactSection" class="footer-info-section" style="display: none;">
  <h2>Contact Us</h2>
  <p>Call us at 8766880183 or email <strong>campusmart111@gmail.com </strong> for help!</p>
</section>
        <div class="footer-col">
          
          <h4>Explore</h4>
          <ul>
            <li><a href="#">Home</a></li>
            <li><a href="#shopSection">Shop</a></li>
            <li><a href="#sell">Sell</a></li>
            <li><a href="#">About</a></li>
          </ul>
        </div>
       <div class="footer-col">
  <h4>Support</h4>
  <ul>
    <li><a href="#" id="faqLink">FAQ</a></li>
    <li><a href="#" id="returnsLink">Returns</a></li>
    <li><a href="#" id="shippingLink">Shipping</a></li>
    <li><a href="#" id="contactLink">Contact</a></li>
  </ul>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const links = {
      faqLink: "faqSection",
      returnsLink: "returnsSection",
      shippingLink: "shippingSection",
      contactLink: "contactSection"
    };

    Object.entries(links).forEach(([linkId, sectionId]) => {
      const link = document.getElementById(linkId);
      const section = document.getElementById(sectionId);

      if (link && section) {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          // Hide all sections first
          document.querySelectorAll(".footer-info-section").forEach(sec => {
            sec.style.display = "none";
          });
          // Show the selected section
          section.style.display = "block";
          // Smooth scroll to section
          section.scrollIntoView({ behavior: "smooth" });
        });
      }
    });
  });
</script>

        <div class="footer-col">
          <h4>Legal</h4>
          <ul>
              <li><a href="privacy.html" target="_blank">Privacy Policy</a></li>
<li><a href="terms.html" target="_blank">Terms of Service</a></li>
          </ul>
          <div class="footer-social">
            <a href="https://www.instagram.com/aditya_taywade123?igsh=MWg2d2l6c2R1amZjZw==" target="_blank"
              title="Instagram"><i class="fab fa-instagram"></i></a>
            <a href="https://www.linkedin.com/in/aditya-taywade-b514b4331?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=android_app"
              target="_blank" title="LinkedIn"><i class="fab fa-linkedin"></i></a>
            <a href="#" title="Facebook"><i class="fab fa-facebook-f"></i></a>
            <a href="#" title="Twitter"><i class="fab fa-twitter"></i></a>
          </div>
        </div>
      </div>
    </div>
    <div class="footer-bottom">
      &copy; 2024 CampusMart &mdash; All rights reserved.
    </div>
  </footer>

  <!-- Font Awesome CDN for Social Icons -->
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

  <!-- All your JS in one module -->
  <script type="module">
    // 1. Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
    import {
      getDatabase, ref, push, onValue, remove
    } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      onAuthStateChanged,
      signOut,
      sendEmailVerification,
      signInWithPhoneNumber,
      RecaptchaVerifier,
      GoogleAuthProvider,
      signInWithPopup
    } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";

    // 2. Firebase config & init
    const firebaseConfig = {
      apiKey: "AIzaSyAbDaEt1ACIRNyC4QerqZQhTO8VJuNoWfE",
      authDomain: "marketplace-378f6.firebaseapp.com",
      databaseURL: "https://marketplace-378f6-default-rtdb.firebaseio.com",
      projectId: "marketplace-378f6",
      storageBucket: "marketplace-378f6.firebasestorage.app",
      messagingSenderId: "519512596002",
      appId: "1:519512596002:web:b4cd5978ffa111ef55b47b",
      measurementId: "G-7XT82KHEGS"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // 3. Track current user globally
    let currentUser = null;
    onAuthStateChanged(auth, user => {
      currentUser = user;
      // Cart badge update
      if (user) {
        const cartRef = ref(db, `carts/${user.uid}`);
        onValue(cartRef, snap => {
          const badge = document.getElementById("cartBadge");
          const items = snap.val();
          const count = items ? Object.keys(items).length : 0;
          if (badge) {
            badge.textContent = count;
            badge.style.display = count > 0 ? 'inline-block' : 'none';
          }
        });
      }
    });

    // tray
    // Mobile Tray JavaScript
document.addEventListener('DOMContentLoaded', function () {
  const tray = document.getElementById('mobileTray');
  const closeTrayBtn = document.getElementById('closeTrayBtn');
  const trayCartBtn = document.getElementById('trayCartBtn');
  const trayAdminBtn = document.getElementById('trayAdminBtn');
  const trayLoginBtn = document.getElementById('trayLoginBtn');
  const trayLogoutBtn = document.getElementById('trayLogoutBtn');

  // Open tray
  document.querySelector('.market-navbar__hamburger').addEventListener('click', function () {
    tray.classList.add('open');
  });

  // Close tray
  closeTrayBtn.addEventListener('click', function () {
    tray.classList.remove('open');
  });

  // Cart button
  trayCartBtn.onclick = function () {
    window.location.href = 'cart.html';
  };

  // Admin button
  trayAdminBtn.onclick = function () {
    document.getElementById('adminLoginModal').style.display = 'block';
    tray.classList.remove('open');
  };

  // Login/Logout buttons
  trayLoginBtn.onclick = function () {
    document.getElementById('loginModal').style.display = 'block';
    tray.classList.remove('open');
  };

  trayLogoutBtn.onclick = function () {
    if (window.signOut) window.signOut();
    tray.classList.remove('open');
  };

  // Update tray user email
function updateTrayUserEmail() {
  const trayUserEmail = document.getElementById('trayUserEmail');
  const user = auth.currentUser; // Use Firebase's currentUser directly
  if (user && trayUserEmail) {
    trayUserEmail.textContent = user.email;
  } else if (trayUserEmail) {
    trayUserEmail.textContent = 'Not logged in';
  }
}

  // Update tray buttons based on authentication state
  function updateTrayAuthButtons() {
  const user = auth.currentUser; // Use Firebase's currentUser directly
  if (user) {
    trayLoginBtn.style.display = 'none';
    trayLogoutBtn.style.display = 'block';
  } else {
    trayLoginBtn.style.display = 'block';
    trayLogoutBtn.style.display = 'none';
  }
}

  // Listen for auth changes
onAuthStateChanged(auth, user => {
  updateTrayUserEmail(user);
  updateTrayAuthButtons(user);
});
});

    // 4. Login / Logout UI
    document.getElementById('navbarLoginBtn').onclick = () =>
      document.getElementById('loginModal').style.display = 'block';
    document.getElementById('logoutBtn').onclick = () => signOut(auth);

    onAuthStateChanged(auth, user => {
      if (user) {
        document.getElementById('loginModal').style.display = 'none';
        document.getElementById('logoutBtn').style.display = 'inline-block';
        const u = document.getElementById('userEmail');
        if (u) { u.textContent = `Your ID is - ${user.email}`; u.style.display = 'inline-block';u.style.colour = '#555'; }
        document.getElementById('navbarLoginBtn').style.display = 'none';
      } else {
        document.getElementById('logoutBtn').style.display = 'none';
        document.getElementById('userEmail').style.display = 'none';
        document.getElementById('navbarLoginBtn').style.display = 'inline-block';
      }
    });

    // 5. reCAPTCHA
    window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
      size: 'invisible',
      callback: () => { }
    });

    // 6. Admin login
    const adminCreds = { username: "adminuser", password: " " };
    let isAdmin = false;
    document.getElementById("adminLoginBtn").onclick = () =>
      document.getElementById("adminLoginModal").style.display = "block";
    document.getElementById("adminLoginSubmit").onclick = () => {
      const u = document.getElementById("adminUsername").value;
      const p = document.getElementById("adminPassword").value;
      if (u === adminCreds.username && p === adminCreds.password) {
        alert("‚úÖ Admin logged in!"); isAdmin = true;
        document.getElementById("adminLoginModal").style.display = "none";
        displayProducts();
      } else alert("‚ùå Invalid admin credentials.");
    };

    // 7. Auth UI Logic (register/login/google)
    document.getElementById('registerBtn').onclick = () => {
      const e = document.getElementById('authEmail').value,
        p = document.getElementById('authPassword').value;
      createUserWithEmailAndPassword(auth, e, p)
        .then(uc => sendEmailVerification(uc.user).then(() => {
          alert("‚úÖ Verification sent, please check email.");
          document.getElementById('loginModal').style.display = 'none';
          signOut(auth);
        }))
        .catch(err => alert("‚ùå Registration failed: " + err.message));
    };

document.getElementById('loginBtn').onclick = () => {
  const email = document.getElementById('authEmail').value;
  const password = document.getElementById('authPassword').value;
  signInWithEmailAndPassword(auth, email, password)
    .then(userCredential => {
      const user = userCredential.user;
      if (user.emailVerified) {
        alert("‚úÖ Logged in!");
        document.getElementById('loginModal').style.display = 'none';
        updateTrayUserEmail(user);
        updateTrayAuthButtons(user);
      } else {
        alert("‚ùå Please verify your email.");
        signOut(auth);
      }
    })
    .catch(err => alert("‚ùå Login failed: " + err.message));
};

    document.getElementById('googleLoginBtn').onclick = () => {
      const prov = new GoogleAuthProvider();
      signInWithPopup(auth, prov)
        .then(() => { alert("‚úÖ Google Sign-In successful!"); document.getElementById('loginModal').style.display = 'none'; })
        .catch(err => alert("‚ùå Google Sign-In failed: " + err.message));
    };

    // 8. SELL FORM SUBMISSION

    const form = document.getElementById('sellForm');
    const spinner = document.getElementById('loading-spinner');
    const cloudName = 'dobzp321s';
    const uploadPreset = 'your_upload_preset';

    form.addEventListener('submit', async e => {
      e.preventDefault();

      if (!currentUser) {
        alert("Please log in to submit your product.");
        document.getElementById('loginModal').style.display = 'block';
        return;
      }

      spinner.style.display = 'block';

      const imageFile = document.getElementById("imageFile").files[0];
      if (!imageFile) {
        alert("Please select an image file.");
        spinner.style.display = 'none';
        return;
      }

      const fd = new FormData();
      fd.append('file', imageFile);
      fd.append('upload_preset', uploadPreset);

      try {
        const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
          method: 'POST',
          body: fd
        });

        const data = await res.json();
        if (!data.secure_url) throw new Error('Cloudinary upload failed');

        const productImageUrl = data.secure_url; // This is the product image URL

        const orig = parseFloat(document.getElementById('productPrice').value);
        const disp = (orig * 1.025).toFixed(2);

        // Prepare objects
        const product = {
          product_name: document.getElementById('productName').value,
          category: document.getElementById('productCategory').value,
          price: disp,
          description: document.getElementById('productDescription').value,
          image_url: productImageUrl,
          seller_name: document.getElementById('sellerName').value,
          seller_mobile: document.getElementById('sellerMobile').value,
          submitted_by: currentUser.email
        };

        const seller = {
          seller_name: document.getElementById('sellerName').value,
          seller_mobile: document.getElementById('sellerMobile').value,
          submitted_by: currentUser.email
        };

        // 1. Store product details and get key
        const productRef = await push(ref(db, 'products'), product);
        const productKey = productRef.key;

        // 2. Store seller info (linked by product key)
        await push(ref(db, 'sellers'), { ...seller, product_key: productKey });



        // 4. Store buyer payment confirmation (empty at first, to be filled later)
        await push(ref(db, 'buyer_payments'), { product_key: productKey, status: "pending" });

        // 5. (Optional) Store in Google Sheet as before
        fetch('https://script.google.com/macros/s/AKfycbyVVpD3hZEWHmcgUtzcuLykXxYkLhe8q6QOqbo9bd_5tYr--aZdsn7IWWe56keR0TXC/exec', {
          method: 'POST',
          body: JSON.stringify(product),
          headers: { 'Content-Type': 'application/json' }
        });

        spinner.style.display = 'none';

        const fee = (orig * 0.05).toFixed(2);

  const modalHtml = `
  <div id="paymentPromptModal" class="modal" style="display:block;position:fixed;z-index:9999;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);">
    <div style="background:white;padding:20px;margin:auto;position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);width:90%;max-width:500px;text-align:center;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.3);">
      <span id="closePaymentModal" style="position:absolute;top:10px;right:20px;cursor:pointer;font-size:24px">&times;</span>
      <h2>Complete Your Listing</h2>
      <p>Please pay ‚Çπ0.10 to list your product.</p>
      <img src="payment.jpg" alt="UPI QR" style="max-width:250px;margin:20px 0;"/>
      <p>UPI ID: <b>dipaktaywade3@okaxis</b></p>
      <form id="paymentProofForm">
        <input type="text" id="upiRef" placeholder="Enter UPI Reference ID" required style="width:90%;padding:10px;margin:10px 0;border-radius:6px;border:1px solid #ccc;"/>
        <p style="margin:10px 0;font-weight:bold;">Send proof screenshot</p>
        <input type="file" id="upiScreenshot" accept="image/*" required style="margin:10px 0;"/>
        <button type="submit" style="padding:10px 20px;background:#4CAF50;color:white;border:none;border-radius:6px;">Confirm Payment</button>
      </form>
    </div>
  </div>`;
document.body.insertAdjacentHTML('beforeend', modalHtml);
      

        // Add listeners only after modal is added:
        const closeBtn = document.getElementById('closePaymentModal');
        if (closeBtn) {
          closeBtn.addEventListener('click', () => {
            const modal = document.getElementById('paymentPromptModal');
            if (modal) modal.remove();
          });
        }

        const paymentProofForm = document.getElementById('paymentProofForm');
        if (paymentProofForm) {
          paymentProofForm.addEventListener('submit', async event => {
            event.preventDefault();

            const upiRef = document.getElementById('upiRef').value.trim();
            const screenshotFile = document.getElementById('upiScreenshot').files[0];

            if (!upiRef || !screenshotFile) {
              alert("Please enter UPI Reference ID and upload screenshot.");
              return;
            }

            try {
              const fd = new FormData();
              fd.append('file', screenshotFile);
              fd.append('upload_preset', uploadPreset);
              const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
                method: 'POST',
                body: fd
              });

              const data = await res.json();

              if (!data.secure_url) throw new Error('Cloudinary upload failed');

             // Store seller payment confirmation in seller_payments branch
              const paymentData = {
                product_key: productKey,
                user_email: currentUser.email,
                upi_ref: upiRef,
                screenshot_url: data.secure_url,
                timestamp: Date.now(),
                status: "submitted",
                seller_name: document.getElementById('sellerName').value,
                seller_mobile: document.getElementById('sellerMobile').value
              };


              await push(ref(db, 'seller_payments'), paymentData);


              // Send to Google Sheet
              fetch('https://script.google.com/macros/s/AKfycby2Ntc0F-RYlHPS06hm0pzknoLvv_x5P4amj9HbNfeTyhs6MgVaheJcj6BpRigT-8uCHA/exec', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  seller_name: document.getElementById('sellerName').value,
                  seller_mobile: document.getElementById('sellerMobile').value,
                  seller_email: currentUser.email,
                  product_name: document.getElementById('productName').value,
                  product_image: productImageUrl, // Use the correct variable here!
                  upi_ref: upiRef,
                  confirmation_screenshot: data.secure_url, // Cloudinary URL of screenshot
                  timestamp: Date.now()
                })
              });

              alert("‚úÖ Payment proof submitted successfully!");
              document.getElementById('paymentPromptModal').remove();

              paymentProofForm.reset();

            } catch (err) {
              console.error(err);
              alert("‚ùå Error submitting payment proof: " + err.message);
            }
          });
        }

      } catch (err) {
        console.error(err);
        alert("‚ùå Error uploading image: " + err.message);
      } finally {
        spinner.style.display = 'none';
      }
    });
    form.reset();

    // --- FILTER & SORT LOGIC ---
    const filterBtn = document.getElementById('filterBtn');
    const filterDropdown = document.getElementById('filterDropdown');
    const applyFilterBtn = document.getElementById('applyFilterBtn');
    const sortSelect = document.getElementById('sortSelect');
    let activeFilters = { categories: [], minPrice: null, maxPrice: null };
    let activeSort = 'recent';

    filterBtn.addEventListener('click', () => {
      filterDropdown.style.display = filterDropdown.style.display === 'block' ? 'none' : 'block';
    });
    document.addEventListener('click', (e) => {
      if (!filterDropdown.contains(e.target) && e.target !== filterBtn) {
        filterDropdown.style.display = 'none';
      }
    });
    applyFilterBtn.addEventListener('click', () => {
      const checked = Array.from(document.querySelectorAll('.filter-category:checked')).map(cb => cb.value);
      const minPrice = parseFloat(document.getElementById('minPrice').value) || null;
      const maxPrice = parseFloat(document.getElementById('maxPrice').value) || null;
      activeFilters = { categories: checked, minPrice, maxPrice };
      displayProducts(document.getElementById('searchInput').value.trim());
      filterDropdown.style.display = 'none';
    });
    sortSelect.addEventListener('change', () => {
      activeSort = sortSelect.value;
      displayProducts(document.getElementById('searchInput').value.trim());
    });

    // 9. FETCH & DISPLAY PRODUCTS (CATEGORY-WISE HORIZONTAL SCROLL FOR MOBILE)
     function displayProducts(query = '') {
      const shopSection = document.getElementById('shopSection');
      const loadingSpinner = document.getElementById('product-loading-spinner');
      shopSection.innerHTML = '';
      if (loadingSpinner) loadingSpinner.style.display = 'block';
      onValue(ref(db, 'products'), snap => {
        if (loadingSpinner) loadingSpinner.style.display = 'none';
        const products = [];
        snap.forEach(child => {
          const prod = child.val();
          prod.key = child.key;
          products.push(prod);
        });
        // Filter by query if needed
        let filtered = products;
        if (query) {
          filtered = filtered.filter(p =>
            p.product_name?.toLowerCase().includes(query.toLowerCase()) ||
            p.category?.toLowerCase().includes(query.toLowerCase())
          );
        }
        // Apply category filter
        if (activeFilters.categories.length > 0) {
          filtered = filtered.filter(p => activeFilters.categories.includes(p.category));
        }
        // Apply price filter
        if (activeFilters.minPrice !== null) {
          filtered = filtered.filter(p => parseFloat(p.price) >= activeFilters.minPrice);
        }
        if (activeFilters.maxPrice !== null) {
          filtered = filtered.filter(p => parseFloat(p.price) <= activeFilters.maxPrice);
        }
        // Sort
        if (activeSort === 'low') {
          filtered.sort((a, b) => parseFloat(a.price) - parseFloat(b.price));
        } else if (activeSort === 'high') {
          filtered.sort((a, b) => parseFloat(b.price) - parseFloat(a.price));
        } else if (activeSort === 'az') {
          filtered.sort((a, b) => (a.product_name || '').localeCompare(b.product_name || ''));
        } else if (activeSort === 'za') {
          filtered.sort((a, b) => (b.product_name || '').localeCompare(a.product_name || ''));
        } else if (activeSort === 'recent') {
          filtered.sort((a, b) => (b.key || '').localeCompare(a.key || ''));
        }
        // Group by category
        const categories = {};
        filtered.forEach(p => {
          if (!categories[p.category]) categories[p.category] = [];
          categories[p.category].push(p);
        });
        // For each category, create a section
        Object.keys(categories).forEach(cat => {
          const section = document.createElement('div');
          section.className = 'category-section';
          // Category title
          const title = document.createElement('div');
          title.className = 'category-title';
          title.textContent = cat;
          section.appendChild(title);
          // Horizontal scroll row
          const row = document.createElement('div');
          row.className = 'category-scroll-row';
          // Only render unique product names per category
          const seenNames = new Set();
          categories[cat].forEach(prod => {
            if (seenNames.has(prod.product_name)) return;
            seenNames.add(prod.product_name);
            const card = document.createElement('div');
            card.className = 'product-card';
            card.innerHTML = `
            <img class="product-image" src="${prod.image_url || 'image.png'}" alt="${prod.product_name}">
            <h3>${prod.product_name || ''}</h3>
            <p>${prod.description || ''}</p>
            <p><b>Price:</b> ‚Çπ${prod.price || '0.00'}</p>
            <p><b>Category:</b> ${prod.category || ''}</p>
          `;
            // Add click handler to proceed to payment page
            card.style.cursor = 'pointer';
            card.addEventListener('click', () => {
              localStorage.setItem('selectedProduct', JSON.stringify(prod));
              window.location.href = 'payment.html';
            });
            row.appendChild(card);
          });
          section.appendChild(row);
          shopSection.appendChild(section);
        });
      });
    }
    document.getElementById('categoryFilter').addEventListener('change', () => displayProducts(document.getElementById('searchInput').value.trim()));
    document.getElementById('searchInput').addEventListener('input', e => displayProducts(e.target.value.trim()));
    displayProducts();

  </script>

  <!-- Login Modal -->

  <div id="loginModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="document.getElementById('loginModal').style.display='none'">&times;</span>
      <h2>Login or Register</h2>

      <!-- Email Login -->
      <input type="email" id="authEmail" placeholder="Enter your email">
      <input type="password" id="authPassword" placeholder="Enter your password">

     <!-- Google Login -->
      <button id="googleLoginBtn" class="google-btn" style="display:flex;align-items:center;gap:10px;justify-content:center;width:100%;padding:10px 0;margin:18px 0 10px 0;background:#fff;border:1px solid #ccc;border-radius:6px;cursor:pointer;transition:box-shadow 0.2s;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
        <svg class="google-icon" width="24" height="24" viewBox="0 0 48 48" style="width:24px;height:24px;display:inline-block;vertical-align:middle;flex-shrink:0;">
          <g>
            <path fill="#4285F4" d="M43.6 20.5h-1.9V20H24v8h11.3c-1.5 4-5.2 7-9.3 7-5.5 0-10-4.5-10-10s4.5-10 10-10c2.4 0 4.6 0.9 6.3 2.3l6.1-6.1C34.5 8.1 29.5 6 24 6 13.5 6 5 14.5 5 25s8.5 19 19 19c10.5 0 19-8.5 19-19 0-1.3-0.1-2.7-0.4-4z"/>
            <path fill="#34A853" d="M24 44c5.1 0 9.4-1.7 12.5-4.7l-6.1-5.1c-1.7 1.1-3.8 1.8-6.4 1.8-4.1 0-7.8-2.7-9.1-6.4H8.2v5.3C11.3 40.3 17.2 44 24 44z"/>
            <path fill="#FBBC05" d="M14.9 29.6c-0.4-1.1-0.7-2.3-0.7-3.6s0.3-2.5 0.7-3.6v-5.3H8.2C7.1 19.7 6 22.2 6 25s1.1 5.3 2.2 7.4l6.7-5.8z"/>
            <path fill="#EA4335" d="M24 14.5c2.6 0 4.9 0.9 6.7 2.7l5-5C32.9 9.1 28.7 7 24 7c-6.8 0-12.7 3.7-15.8 9.3l6.7 5.3c1.3-3.7 5-6.4 9.1-6.4z"/>
            <path fill="none" d="M0 0h48v48H0z"/>
          </g>
        </svg>
        <span style="font-size:1.05rem;color:#222;font-weight:500;display:inline-block;vertical-align:middle;">Sign in with Google</span>
      </button>
      <!-- Buttons -->
      <div class="btn-group">
        <button id="loginBtn">Login</button>
        <button id="registerBtn">Sign Up</button>
      </div>
    </div>
  </div>

  <div id="adminLoginModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="document.getElementById('adminLoginModal').style.display='none'">&times;</span>
      <h2>Admin Login</h2>
      <input type="text" id="adminUsername" placeholder="Username">
      <input type="password" id="adminPassword" placeholder="Password">
      <button id="adminLoginSubmit" class="admin-btn">Login as Admin</button>

    </div>
  </div>
  <!-- Payment Modal -->
   
  <!-- <div id="paymentModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Please Pay ‚Çπ<span id="paymentAmount"></span> to List Your Product (5%)</h2>
      <p>UPI ID: <strong>makechange@okaxis</strong></p>
      <img src="payment.jpg" alt="QR Code" style="width: 200px; height: 200px;" />
      <br /><br />
      <a href="https://docs.google.com/forms/d/e/1FAIpQLSfR1LE4DSNF7ng-SjS4DVd4cOm8dpxDKdbGjZ7H4AYcwWQYVQ/viewform?usp=header"
         target="_blank" class="proof-btn">Send Proof of Payment</a>
    </div>
  </div> -->

  
</body>

</html>
